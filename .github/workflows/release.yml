name: Release

# Controls when the workflow will run
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      fork:
        description: "Enter a gvsbuild fork for the build with the latest stack, defaults to wingtk."
        default: "wingtk"
      ref:
        description: "Enter a git ref for checking out the above repository, defaults to main."
        default: "main"
      makeLatest:
        description: "Mark this release as latest"
        type: boolean
        default: false
      prerelease:
        description: "Mark this release as pre-release (test/beta)"
        type: boolean
        default: false

jobs:
  build:
    runs-on: windows-2022
    strategy:
      matrix:
        python: ["3.10", "3.13"]
        platform: [x64]
        vstudio: [17]
      fail-fast: false

    steps:
      # Check out this repo for patches
      - uses: actions/checkout@v6
        with:
          path: patches-repo

      # Checks-out gvsbuild repository
      - uses: actions/checkout@v6
        with:
          repository: ${{ github.event.inputs.fork }}/gvsbuild
          fetch-depth: 0
          ref: ${{ github.event.inputs.ref }}
          path: gvsbuild

      # Apply glib patches
      - name: Apply glib patches
        shell: pwsh
        run: |
          ${{ github.workspace }}\patches-repo\apply-glib-patches.ps1 -gvsbuildRoot "${{ github.workspace }}\gvsbuild"

      # Get gvsbuild commit SHA for release naming
      - name: Get gvsbuild commit
        id: gvsbuild-commit
        working-directory: gvsbuild
        shell: bash
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python }}
          architecture: ${{ matrix.platform }}

      - name: Install Build Deps
        # Pin setuptools<81 to avoid breaking g-ir-scanner on Windows
        run: python -m pip install "setuptools<81" wheel build

      - name: Install gvsbuild tool
        working-directory: gvsbuild
        run: python -m pip install .

      - name: Build
        working-directory: gvsbuild
        run: >
          gvsbuild build
          --platform=${{ matrix.platform }}
          --configuration=release
          --ninja-opts -j2
          --enable-gi
          --py-wheel
          gtk3 pygobject lz4 enchant adwaita-icon-theme

      - name: Zip Bundle
        run: >
          7z a
          ${{ github.workspace }}/${{ env.release_name }}.zip
          "C:\gtk-build\gtk\${{matrix.platform}}\release"
        env:
          release_name: "gvsbuild-py${{ matrix.python }}-vs${{ matrix.vstudio }}-${{ matrix.platform }}"

      - name: Release
        uses: ncipollo/release-action@v1
        with:
          name: gvsbuild-${{ github.event.inputs.ref }}-${{ steps.gvsbuild-commit.outputs.sha }}
          commit: ${{ github.sha }}
          tag: gvsbuild-${{ github.event.inputs.ref }}-${{ steps.gvsbuild-commit.outputs.sha }}
          body: |
            gvsbuild build from `${{ github.event.inputs.fork }}/gvsbuild@${{ github.event.inputs.ref }}`
            gvsbuild commit: `${{ steps.gvsbuild-commit.outputs.sha }}`
          makeLatest: ${{ github.event.inputs.makeLatest == 'true' }}
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          allowUpdates: true
          replacesArtifacts: true
          artifacts: "*.zip"
